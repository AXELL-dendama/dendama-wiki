<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>music</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-900 text-gray-200 font-mono">
    <div class="container mx-auto p-4">
      <div class="wiki wiki-page">
        <a name="Online対戦"></a>
        <h1>Online対戦<br /></h1>
        <ul>
          <li>
            Online対戦はWebSocketでOnline対戦専用のSocketサーバーとクライアントをつなぎ、情報のやりとりを行う。
          </li>
          <li>socketでの実装はNodejsのライブラリであるsocket.ioを利用する</li>
          <li>
            socket通信で可能なことは下記
            <ul>
              <li>
                同じサーバにsocketで繋がれているクライアントに対し、一斉送信
              </li>
              <li>
                特定のID（RoomID）に繋いでいるクライアントに対しての一斉送信
              </li>
              <li>特手のクライアントへの情報送信</li>
            </ul>
          </li>
        </ul>
        <ul>
          <li>
            WebSocket設定値
            <table class="ms-rteTable-2">
              <tbody>
                <tr class="ms-rteTableEvenRow-2">
                  <td class="ms-rteTableEvenCol-2">heartbeat timeout</td>
                  <td class="ms-rteTableOddCol-2">10s</td>
                </tr>
                <tr class="ms-rteTableOddRow-2">
                  <td class="ms-rteTableEvenCol-2">heartbeat interval</td>
                  <td class="ms-rteTableOddCol-2">5s</td>
                </tr>
              </tbody>
            </table>
            <br />
          </li>
        </ul>
        <ul>
          <li>
            WebSocketのイベント
            <table class="ms-rteTable-4">
              <tbody>
                <tr class="ms-rteTableEvenRow-4">
                  <td class="ms-rteTableEvenCol-4">init</td>
                  <td class="ms-rteTableOddCol-4">roomへの入室</td>
                  <td class="ms-rteTableEvenCol-4">
                    socket.join, io.to(room_id).emit(&#39;ready&#39;,
                    data)(送信者も含めて通知)
                  </td>
                </tr>
                <tr class="ms-rteTableOddRow-4">
                  <td class="ms-rteTableEvenCol-4">ready</td>
                  <td class="ms-rteTableOddCol-4">入室したことの通知</td>
                  <td class="ms-rteTableEvenCol-4">
                    io.to(送信者も含めて通知)
                  </td>
                </tr>
                <tr class="ms-rteTableEvenRow-4">
                  <td class="ms-rteTableEvenCol-4">game_start</td>
                  <td class="ms-rteTableOddCol-4">
                    対戦相手も入室しているか確認してゲームスタート
                  </td>
                  <td class="ms-rteTableEvenCol-4">
                    io.to(送信者も含めて通知)
                  </td>
                </tr>
                <tr class="ms-rteTableOddRow-4">
                  <td class="ms-rteTableEvenCol-4">battle_info</td>
                  <td class="ms-rteTableOddCol-4">
                    状況の共有（技の情報、点数など）
                  </td>
                  <td class="ms-rteTableEvenCol-4">
                    socket.broadcast.to(送信者以外に通知)
                  </td>
                </tr>
                <tr class="ms-rteTableEvenRow-4">
                  <td class="ms-rteTableEvenCol-4">final_result</td>
                  <td class="ms-rteTableOddCol-4">最終結果の通知</td>
                  <td class="ms-rteTableEvenCol-4">
                    io.to(送信者も含めて通知)
                  </td>
                </tr>
                <tr class="ms-rteTableOddRow-4">
                  <td class="ms-rteTableEvenCol-4">count_down</td>
                  <td class="ms-rteTableOddCol-4">
                    サーバサイドでカウントダウンした結果を通知
                  </td>
                  <td class="ms-rteTableEvenCol-4">
                    io.to(送信者も含めて通知)
                  </td>
                </tr>
                <tr class="ms-rteTableEvenRow-4">
                  <td class="ms-rteTableEvenCol-4">disconnect</td>
                  <td class="ms-rteTableOddCol-4">disconnectの通知</td>
                  <td class="ms-rteTableEvenCol-4">
                    io.to(送信者も含めて通知)
                  </td>
                </tr>
              </tbody>
            </table>
            <br />
          </li>
        </ul>
        <ul>
          <li>
            サーバサイドのFlag
            <ul>
              <li>
                broadcast
                <ul>
                  <li>
                    送信者以外への送信<br />
                    <pre
                      style="
                        margin: 1em 1em 1em 1.6em;
                        padding: 8px;
                        background-color: #3d3d3d;
                        border: 1px solid #e2e2e2;
                        border-radius: 3px;
                        width: auto;
                      "
                    >
io.on(&#39;connection&#39;, (socket) =&gt; {
  socket.broadcast.emit(&#39;an event&#39;, { some: &#39;data&#39; }); // everyone gets it but the sender
});
</pre
                    >
                  </li>
                </ul>
              </li>
              <li>
                namespace.to(room)
                <ul>
                  <li>
                    指定されたルームに参加したクライアントにのみブロードキャストされる<br />
                    <pre
                      style="
                        margin: 1em 1em 1em 1.6em;
                        padding: 8px;
                        background-color: #3d3d3d;
                        border: 1px solid #e2e2e2;
                        border-radius: 3px;
                        width: auto;
                      "
                    >
namespace.to(&#39;level1&#39;).emit(&#39;an event&#39;, { some: &#39;data&#39; });
</pre
                    >
                  </li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
        <ul>
          <li>
            実際のサーバサイドでの処理
            <ul>
              <li>
                上記の処理を組み合わせて、電玉は下記のように利用
                <ul>
                  <li>自分以外への情報送信</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
        <ul>
          <li>シーケンス<br /></li>
        </ul>
        <a name="socket通信と通常のHTTP通信との違い"></a>
        <h3>
          <strong>socket通信と通常のHTTP通信との違い</strong>
        </h3>
        <p>
          <img
            src="./img/socketio1_1.jpg"
            alt="socketio1_1.jpg"
            data-themekey="#"
            style="margin: 5px"
          />
          <br />
          <img
            src="./img/socketio1_2.jpg"
            alt="socketio1_2.jpg"
            data-themekey="#"
            style="margin: 5px"
          />
          <br />
        </p>
      </div>
      <br />
    </div>
  </body>
</html>
